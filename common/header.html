<script src="https://unpkg.com/markerjs"></script>



<script>
//Save unsaved marker state before reopening when resizing reply-control
       function saveState(newObj, image, mark){
                   newObj.img = image
                   newObj.previousState = mark.getState();
                   return newObj
        }


        function findAllIndexes(string,word){
                    let result = [];
                    let dif = 0;
                    let i = 0;
                    let wordLength  = word[0].length

                    while(true){
                            let index = string.indexOf(word[i]);
                        
                        if(word.length > 1)
                        {
                            console.log("word>1")
                            let i
                            let theList = new Array(4)
                        for(i = 0; i < 4 ; i++)
                            theList[i] = string.indexOf(word[i])

                            if(theList[0] == -1 && theList[1] == -1 && theList[2] == -1 && theList[3] == -1)
                            {
                                console.log(theList)
                                index = -1
                                console.log("All -1")
                            }
                                
                                // Find minimum number in array
                                else{
                                    console.log(theList)
                                    let newArray = theList.filter( x => x > -1)
                                    index = Math.min(...newArray)
                                    console.log("min " + index)

                                        if(theList.indexOf(index) == 3)
                                            wordLength = 4;
                                        else
                                            wordLength = 3;
                                    }
                                }
                            if(index === -1) break;
                                else{

                                    console.log("index " + index , "diff " +dif)
                                    result.push(index + dif);
                                    let cur = string.length;
                                    string = string.substring(index + wordLength);
                                    dif += cur - string.length;
                                    console.log("final dif " +dif )
                        }
                        }

                        console.log("result before returning "  + result)
                        return result;
        }
  
// Display Markerjs
            let previousState
       function showMarkerJs(img, config) {
            let mark = new markerjs.MarkerArea(img, {previousState: config, renderImageType: 'image/jpeg'});
            var $editor = $('#reply-control textarea.d-editor-input').first()[0].value;
            var $editorVal = $('#reply-control textarea.d-editor-input');
            let images = $('.d-editor-preview img');
            let options = ["]("]
            let options2 = ['jpg', 'png', 'gif','jpeg']
            let options3 = ["!["]
            let options4 = (")")
            let begin = findAllIndexes($editor,options);
            let endpoints = findAllIndexes($editor, options2)
            let begin2 = findAllIndexes($editor,options3);
            let endpoints2 = findAllIndexes($editor,options4);

            console.log("begin2: " + begin2)
            console.log("end2: " + endpoints2)

            //Exec after marker's toolbar checkmark is clicked
            mark.show((dataUrl) => {
                  
                    // generating image src into blob url
                    let base64code = dataUrl;
                    base64code = base64code.split(',').pop();

                    const src = base64code;
                    const byteChar = atob(src)
                    const byteNum = new Array(byteChar.length);

                    for (let i = 0; i < byteChar.length; i++){
                        byteNum[i] = byteChar.charCodeAt(i);
                    }
                    const byteArr = new Uint8Array(byteNum);
                    const blob = new Blob([byteArr], {type: 'img/png'});


                    // upload
                    const data = new FormData();
                    data.append('authenticity_token', $('meta[name="csrf-token"]').attr('content'))
                    data.append('file', blob, 'png');
                    data.append('type', "composer");

                    fetch(Discourse.getURL("/uploads.json"), {
                        method: 'POST',
                        body: data
                    }).then(response => response.json()).then(upload=> {
                        
                        //Get the new url
                        var newImgUrl = upload.short_url.substring(0,upload.short_url.length-4);
                        var str;
                        var newText;
                        for(let i = 0; i < images.length; i++){
                            if(images[i] === img){
                                str = $editor.substring(begin2[i], endpoints2[i]+1)
                                newText = $editor.replace(str , "![Uploading ...]()")
                                $editorVal.val(newText)
                                str = $editor.substring(begin[i]+2, endpoints[i])
                                console.log('old image: ',str)
                                break;
                            }
                        }
                        
                        Discourse.appEvents.trigger(
                            "composer:insert-text",
                            "",                     
                            );
                        setTimeout(function(){
                            Discourse.appEvents.trigger(
                            "composer:insert-text",
                            "",
                            newText = $editor.replace(str,newImgUrl),
                            $editorVal.val(newText)                       
                            );
                            }, 1500)

                        //Replace old url and textarea with update ones
                 

                     });

                });  

                   //Makes sure markerjs toolbar is closed after preview topic is closed.
                   function checkOpen(){ 
                           if(!$(img).is(':visible')) {
                           try{
                               clearInterval(timer) 
                               mark.close();
                               }
                           catch(e)
                               {/*Do nothing*/}
                               }
                           } 
                   let timer = setInterval(checkOpen,3000);
                   
                   newObj = {
                               img,
                               previousState: mark.getState(),
                               mark
                           }
                   
                   //Hide composer scrolling temporarily
                   $(".d-editor-preview-wrapper ").css("overflow","hidden");
               
                   //Save state when toolbar clicked
                   $('.markerjs-toolbar').on("click", function(){
                       return saveState(newObj, img, mark)
                       })
                   //Save state when annotation changes
                   $('svg').on("click", function(){
                       return saveState(newObj, img, mark)
                       })                       
                       return newObj
       }
</script> 
