<script src="https://unpkg.com/markerjs"></script>



<script>
//Save unsaved marker state before reopening when resizing reply-control
       function saveState(newObj, image, mark){
                   newObj.img = image
                   newObj.previousState = mark.getState();
                   return newObj
        }

        function findAllIndexes(string,word){
                    let result = [];
                    let dif = 0;
                    let i = 0;
                   
                    while(true){
                        let index = string.indexOf(word[i]);
                       
                    if(word.length > 1)
                    {
                        let i
                        let theList = new Array(4)
                    for(i = 0; i < 4 ; i++)
                        theList[i] = string.indexOf(word[i])

                        if(theList[0] == -1 && theList[1] == -1 && theList[2] == -1 && theList[3] == -1)
                            index = -1
                            
                            // Find minimum number in array
                            else{
                                let newArray = theList.filter( x => x > -1)
                                index = Math.min(...newArray)
                                }
                            }
                        if(index === -1) break;
                            else{
                                result.push(index + dif);
                                let cur = string.length;
                                string = string.substring(index + word[0].length);
                                dif += cur - string.length;
                    }
                    }
                    return result;
        }
  
// Display Markerjs
            let previousState
       function showMarkerJs(img, config) {
            let mark = new markerjs.MarkerArea(img, {previousState: config, renderImageType: 'image/jpeg'});
            let $editor = $('#reply-control textarea.d-editor-input').first()[0].value;
            let $editorVal = $('#reply-control textarea.d-editor-input');
            let images = $('.d-editor-preview img');
            let options = ["]("]
            let options2 = ['jpg', 'png', 'gif','jpeg']
            let result = findAllIndexes($editor,options);
            let endpoints = findAllIndexes($editor, options2)
            console.log("begin: " + result)
            console.log("end: " + endpoints)

            //Exec after marker's toolbar checkmark is clicked
            mark.show((dataUrl) => {
                  
                    // generating image src into blob url
                    let base64code = dataUrl;
                    base64code = base64code.split(',').pop();

                    const src = base64code;
                    const byteChar = atob(src)
                    const byteNum = new Array(byteChar.length);

                    for (let i = 0; i < byteChar.length; i++){
                        byteNum[i] = byteChar.charCodeAt(i);
                    }
                    const byteArr = new Uint8Array(byteNum);
                    const blob = new Blob([byteArr], {type: 'img/png'});


                    // upload
                    const data = new FormData();
                    data.append('authenticity_token', $('meta[name="csrf-token"]').attr('content'))
                    data.append('file', blob, 'png');
                    data.append('type', "composer");

                    fetch(Discourse.getURL("/uploads.json"), {
                        method: 'POST',
                        body: data
                    }).then(response => response.json()).then(upload=> {
                        
                        //Get the new url
                        const newImgUrl = upload.short_url.substring(0,upload.short_url.length-4);
                        let str;
                        for(let i = 0; i < images.length; i++){
                            if(images[i] === img){    
                                str = $editor.substring(result[i]+2, endpoints[i])
                            console.log('old image: ',str)
                            break;
                            }
                        }
                        console.log("new image: " + newImgUrl)
                        //Replace old url and textarea with update ones
                        let newText;
                        Discourse.appEvents.trigger(
                            "composer:insert-text",
                            "",
                            newText = $editor.replace(str,newImgUrl),
                            $editorVal.val(newText)
                            );
                     });
        
                });  

                   //Makes sure markerjs toolbar is closed after preview topic is closed.
                   function checkOpen(){ 
                           if(!$(img).is(':visible')) {
                           try{
                               clearInterval(timer) 
                               mark.close();
                               }
                           catch(e)
                               {/*Do nothing*/}
                               }
                           } 
                   let timer = setInterval(checkOpen,3000);
                   
                   newObj = {
                               img,
                               previousState: mark.getState(),
                               mark
                           }
                   
                   //Hide composer scrolling temporarily
                   $(".d-editor-preview-wrapper ").css("overflow","hidden");
               
                   //Save state when toolbar clicked
                   $('.markerjs-toolbar').on("click", function(){
                       return saveState(newObj, img, mark)
                       })
                   //Save state when annotation changes
                   $('svg').on("click", function(){
                       return saveState(newObj, img, mark)
                       })                       
                       return newObj
       }
</script> 
