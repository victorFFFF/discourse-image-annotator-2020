<script src="https://unpkg.com/markerjs"></script>



<script>
//Save unsaved marker state before reopening when resizing reply-control
       function saveState(newObj, image, mark){
                   newObj.img = image
                   newObj.previousState = mark.getState();
                   return newObj
        }


        function findAllIndexes(string,word){
                    let result = [];
                    let dif = 0;
 
                    while(true){
                            let index = string.indexOf(word);           
                            if(index === -1) break;
                                else{
                                    result.push(index + dif);
                                    let cur = string.length;
                                    string = string.substring(index + word[0].length);
                                    dif += cur - string.length;
                        }
                        }
                        return result;
        }
  
// Display Markerjs
            let previousState
       function showMarkerJs(img, config) {
            let mark = new markerjs.MarkerArea(img, {previousState: config});
            var $editor = $('#reply-control textarea.d-editor-input').first()[0].value;
            var $editorVal = $('#reply-control textarea.d-editor-input');
            let images = $('.d-editor-preview img');
            let options1 = ["!["]
            let options2 = ["]("]
            let options3 = (")")
            let begin = findAllIndexes($editor,options1);
            let afterBegin = findAllIndexes($editor,options2);
            let endpoints = findAllIndexes($editor,options3);



            //Exec after marker's toolbar checkmark is clicked
            mark.show((dataUrl) => {
                  
                    // generating image src into blob url
                    let base64code = dataUrl;
                    base64code = base64code.split(',').pop();

                    const src = base64code;
                    const byteChar = atob(src)
                    const byteNum = new Array(byteChar.length);

                    for (let i = 0; i < byteChar.length; i++){
                        byteNum[i] = byteChar.charCodeAt(i);
                    }
                    const byteArr = new Uint8Array(byteNum);
                    const blob = new Blob([byteArr], {type: 'img/png'});


                    // upload
                    const data = new FormData();
                    data.append('authenticity_token', $('meta[name="csrf-token"]').attr('content'))
                    data.append('file', blob, 'png');
                    data.append('type', "composer");

                    fetch(Discourse.getURL("/uploads.json"), {
                        method: 'POST',
                        body: data
                    }).then(response => response.json()).then(upload=> {
                        
                        //Get the new url
                        var newImgUrl = upload.short_url.substring(0,upload.short_url.length-4);
                        var str;
                        var newText;
                        for(let i = 0; i < images.length; i++){
                            if(images[i] === img){
                                str = $editor.substring(begin[i], endpoints[i]+1)
                                newText = $editor.replace(str , "![Uploading ...]()")
                                $editorVal.val(newText)
                                str = $editor.substring(afterBegin[i]+2, endpoints[i])
                                console.log('old image: ',str)
                                break;
                            }
                        }
                        console.log(" new image" + newImgUrl)
                        Discourse.appEvents.trigger(
                            "composer:insert-text",
                            "",                      
                            );
                        setTimeout(function(){
                            Discourse.appEvents.trigger(
                            "composer:insert-text",
                            "",
                            newText = $editor.replace(str,newImgUrl),
                            $editorVal.val(newText)                       
                            );
                            }, 2000)
                     });

        
                });  

                   //Makes sure markerjs toolbar is closed after preview topic is closed.
                   function checkOpen(){ 
                           if(!$(img).is(':visible')) {
                           try{
                               clearInterval(timer) 
                               mark.close();
                               }
                           catch(e)
                               {/*Do nothing*/}
                               }
                           } 
                   let timer = setInterval(checkOpen,3000);
                   
                   newObj = {
                               img,
                               previousState: mark.getState(),
                               mark
                           }
                   
                   //Hide composer scrolling temporarily
                   $(".d-editor-preview-wrapper ").css("overflow","hidden");
               
                   //Save state when toolbar clicked
                   $('.markerjs-toolbar').on("click", function(){
                       return saveState(newObj, img, mark)
                       })
                   //Save state when annotation changes
                   $('svg').on("click", function(){
                       return saveState(newObj, img, mark)
                       })                       
                       return newObj
       }
</script> 
